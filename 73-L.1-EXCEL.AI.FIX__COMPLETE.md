# Phase 73-L.1: Excel Import AI Layer Fix (모객 원본 기준) ✅

## 목표
모객 원본 13컬럼만으로 참가자 표준화/저장까지 자동 처리.
SFE 코드·담당자 정보 누락 수정, event_rooms 참조 제거, 업로드 즉시 UI 반영.

## 완료된 작업

### 1️⃣ DB 마이그레이션
**파일**: `supabase/migrations/[timestamp]_phase73_l1_excel_ai_fix.sql`

- `participants_log`에 `upload_session_id` 컬럼 추가 (추적용)
- `fn_bulk_upload_participants` RPC 완전 재작성:
  - 13컬럼 자동감지 (한글 헤더 기준, 공백/변형 허용)
  - 담당자 정보 → `manager_info` JSON 항상 생성
  - SFE 코드 처리 (공백/'-' → null)
  - `is_active` 처리 ('Y', '삭제', 'true' → false)
  - 기본값 자동 설정:
    - `role_badge` = '참석자'
    - `composition` = `{"adult": 1, "child": 0, "infant": 0}`
    - `room_type` = '배정대기'
    - `room_credit` = 0
    - `status` = '대기'
  - Upsert 기준: `(event_id, phone)`
  - 성공 시 `pg_notify`로 실시간 UI 갱신
  - 상세 응답: `total`, `new`, `updated`, `skipped`, `session_id`

### 2️⃣ 프론트엔드 업데이트
**파일**: `src/components/dashboard/UploadParticipantsModal.tsx`

**A. 컬럼 매핑 확장**
```typescript
// 13개 컬럼 전체 지원
- 고객 성명, 거래처명, 고객 연락처
- 팀명, 담당자 성명, 담당자 연락처, 담당자 사번
- SFE 거래처코드, SFE 고객코드
- 메모, 행사명, 등록 일시, 삭제유무
```

**B. manager_info JSON 구성**
```typescript
const managerInfo = {
  team: v_team_name,
  name: v_manager_name,
  phone: v_manager_phone,
  emp_id: v_manager_emp_id
};
// 일부가 비어도 항상 생성
```

**C. SFE 코드 처리**
- 공백 또는 '-' → `null`로 변환
- 숫자·문자 혼용 허용

**D. UI 개선**
- 안내 문구 업데이트 (13컬럼 명시)
- 미리보기 추가: 처음 5명의 매핑 결과 표시
  ```
  1. 홍길동 | ABC회사 | 01012345678 | 김담당 | SFE: H123/C456
  2. ...
  ```
- 토스트 메시지 상세화:
  ```
  총 145건 처리 → 신규 120명 / 갱신 20명 / 스킵 5건.
  담당자정보·SFE코드 보정완료.
  ```

## 입력 Excel 스키마 (필수 13컬럼)
| 컬럼명 | 매핑 필드 | 처리 규칙 |
|--------|-----------|-----------|
| 행사명 | event_name | 검증용 (미사용) |
| 팀명 | team_name | manager_info.team |
| 담당자 성명 | manager_name | manager_info.name |
| 담당자 연락처 | manager_phone | 숫자만, manager_info.phone |
| 고객 성명 | name | 필수, trim |
| 거래처명 | organization | |
| SFE 거래처코드 | sfe_hospital_code | 공백/'-' → null |
| SFE 고객코드 | sfe_customer_code | 공백/'-' → null |
| 고객 연락처 | phone | 숫자만, 중복 키 |
| 메모 | memo | |
| 담당자 사번 | manager_emp_id | manager_info.emp_id |
| 등록 일시 | registered_at | 메타데이터 |
| 삭제유무 | is_active | 'Y'/'삭제' → false |

## 매핑 규칙
### A. participants 테이블
- `name`: 고객 성명 (trim, 필수)
- `organization`: 거래처명
- `phone`: 고객 연락처 (숫자만, 중복 키)
- `memo`: 메모
- `team_name`, `manager_name`, `manager_phone`: 담당자 개별 필드
- `manager_info`: JSON `{team, name, phone, emp_id}`
- `sfe_hospital_code`, `sfe_customer_code`: SFE 코드 (null 허용)
- `is_active`: 'Y', '삭제', 'true' → false / 나머지 true
- 기본값: `role_badge='참석자'`, `composition={adult:1}`, `room_type='배정대기'` 등

### B. Upsert 규칙
- 중복 키: `(event_id, phone)`
- 기존 레코드 있으면 merge (위 매핑 필드만 갱신)
- `is_active=false`는 그대로 유지 (삭제 복구는 별도 기능)

### C. 로그 기록
- `participants_log` 테이블에 `upload_session_id` 기록
- `action`: 'excel_insert' / 'excel_update'
- 추후 QA 대시보드에서 세션별 조회 가능

## QA 검증 결과 ✅
| 항목 | 결과 |
|------|------|
| 13컬럼 원본 업로드 성공 | ✅ |
| event_rooms 관련 에러 미발생 | ✅ |
| manager_info JSON 항상 생성 | ✅ |
| sfe_hospital_code / sfe_customer_code null 처리 | ✅ |
| is_active 'Y/삭제'만 false | ✅ |
| 동일 이벤트·연락처 중복 시 업데이트 | ✅ |
| 업로드 종료 후 참가자 리스트 즉시 갱신 | ✅ |
| 미리보기 5명 표시 | ✅ |
| 토스트 상세 카운트 표시 | ✅ |

## 기술 스택
- Frontend: React, TypeScript, SWR, XLSX
- Backend: Supabase (PostgreSQL + RPC)
- Realtime: pg_notify → SWR cache invalidation

## 마이그레이션 파일
- `supabase/migrations/[timestamp]_phase73_l1_excel_ai_fix.sql`

## 산출물
1. 업데이트된 RPC 함수: `fn_bulk_upload_participants`
2. 프론트 업로드 모달 개선: `UploadParticipantsModal.tsx`
3. QA 체크리스트 완료 확인

## 완료 기준 (AC) ✅
- [x] 원본 13컬럼만으로 에러 없이 업로드/반영
- [x] 담당자/SFE 코드 누락 0
- [x] 업로드 후 즉시 UI 반영 (SWR cache invalidation)
- [x] 중복 업로드 시 merge 동작 확인
- [x] 미리보기 및 상세 토스트 메시지

## 완료 로그
```
[Phase 73-L.1]
✅ DB: participants_log.upload_session_id added
✅ RPC: fn_bulk_upload_participants rewritten (13-column)
✅ Frontend: UploadParticipantsModal enhanced
✅ Column mapping: all 13 columns supported
✅ manager_info: always created as JSON
✅ SFE codes: blank/dash → null
✅ is_active: handled correctly
✅ Upsert: (event_id, phone) merge
✅ Preview: first 5 rows shown
✅ Toast: detailed counts displayed
✅ QA: all checks passed
```

## 참고사항
- Phase 73-L.1 완료 후 다음 단계:
  - Phase 73-L.2: Excel Export 13-column sync
  - Phase 73-L.3: TM Status integration with recruitment data
- event_rooms 참조는 RoomingTab.tsx에 남아있으나 업로드 로직과 무관
- AI 통계·요약 대시보드 관련 RPC·뷰는 별도 단계에서 구현 예정 (스킵됨)
