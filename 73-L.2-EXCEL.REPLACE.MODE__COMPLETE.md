# Phase 73-L.2: Excel Upload Layer Rebuild + Replace Mode â€” COMPLETE âœ…

**Tag**: `73-L2.UPLOAD-REBUILD`  
**Branch**: `phase/73-L2-excel-replace`  
**Date**: 2025-10-30

---

## ğŸ¯ Objectives

1. âœ… Fix `column "team_name" does not exist` error permanently
2. âœ… Add Replace mode for Excel upload (delete all existing participants before upload)
3. âœ… Remove "ì„±ì¸/ì†Œì•„/ìœ ì•„ ê¸°ë³¸ê°’" text from UI
4. âœ… Make "í–‰ì‚¬ëª…/ì‚­ì œìœ ë¬´" optional columns
5. âœ… Fix manager info and SFE code handling completely

---

## ğŸ§± 1. Database Changes

### New RPC Function: `ai_participant_import_from_excel`

**Location**: `supabase/migrations/20251030012024_a4cf96b3-4827-46df-827d-1e215d420bb7.sql`

**Key Features**:
- **Replace Mode**: `p_replace` parameter deletes all existing participants before upload
- **No team_name column**: Uses `manager_info` JSON only
- **Auto-mapping**: 13 Korean column headers â†’ standard fields
- **Upsert**: Conflict on `(event_id, phone)` â†’ update existing
- **Default values**: `role_badge='ì°¸ì„ì'`, `composition={"adult":1,"child":0,"infant":0}`, etc.
- **Logging**: Records to `participants_log` with session tracking
- **Real-time**: Broadcasts `pg_notify` for instant UI updates

**Signature**:
```sql
ai_participant_import_from_excel(
  p_event_id uuid,
  p_data jsonb,
  p_replace boolean DEFAULT false
) RETURNS jsonb
```

**Return Value**:
```json
{
  "success": true,
  "total": 145,
  "deleted": 0,
  "mode": "merge",
  "event_id": "uuid",
  "agency_id": "uuid",
  "session_id": "excel_1234567890"
}
```

---

## ğŸ’» 2. Frontend Changes

### File: `src/components/dashboard/UploadParticipantsModal.tsx`

**Changes**:

1. **Added Replace Mode Toggle**:
   - Two-button selector: "ê¸°ì¡´ ìœ ì§€ (ì—…ë°ì´íŠ¸)" / "ì „ì²´ êµì²´ (Replace)"
   - Warning text when Replace mode is active
   - State variable: `replaceMode`

2. **Updated RPC Call**:
   - Changed from `fn_bulk_upload_participants` to `ai_participant_import_from_excel`
   - Passes `p_replace` parameter
   - Simplified data structure (removed individual manager fields)

3. **Revised UI Text**:
   - âœ… Removed: "ì„±ì¸/ì†Œì•„/ìœ ì•„ ë“±ì€ ë¹„ì›Œë‘ì„¸ìš”"
   - âœ… Added: "í–‰ì‚¬ëª…/ì‚­ì œìœ ë¬´ ì»¬ëŸ¼ì€ ì„ íƒì ìœ¼ë¡œ í¬í•¨ ê°€ëŠ¥"
   - âœ… Updated: Required fields to "ê³ ê° ì„±ëª…, ê³ ê° ì—°ë½ì²˜"

4. **Improved Toast Messages**:
   - Replace mode: "ê¸°ì¡´ ì°¸ê°€ì Xëª…ì„ ì‚­ì œí•˜ê³  ìƒˆë¡œ Yëª…ì„ ì—…ë¡œë“œí–ˆìŠµë‹ˆë‹¤."
   - Update mode: "ì´ Xëª… ì²˜ë¦¬ ì™„ë£Œ. ë‹´ë‹¹ìì •ë³´Â·SFEì½”ë“œ ìë™ ë§¤í•‘ë¨."

5. **Preview Section**:
   - Shows first 3 rows (reduced from 5)
   - Displays: name, organization, phone, manager name, SFE codes

---

## ğŸ§ª 3. QA Checklist

| # | Test Case | Status |
|---|-----------|--------|
| 1 | Upload 13-column Excel with existing data (Update mode) | âœ… |
| 2 | Upload 13-column Excel with Replace mode | âœ… |
| 3 | `manager_info` JSON created correctly | âœ… |
| 4 | Missing "í–‰ì‚¬ëª…/ì‚­ì œìœ ë¬´" columns handled | âœ… |
| 5 | No `team_name` column error | âœ… |
| 6 | UI updates immediately after upload | âœ… |
| 7 | SFE codes with blank/'-' stored as NULL | âœ… |
| 8 | Duplicate phone numbers merged (upsert) | âœ… |

---

## ğŸ“¦ Deliverables

1. âœ… **Migration**: New RPC function with Replace mode
2. âœ… **Frontend**: Updated upload modal with mode toggle
3. âœ… **UI Text**: Revised instructions (removed adult/child/infant mention)
4. âœ… **Real-time**: SWR cache invalidation after upload
5. âœ… **Logging**: Upload activity tracked in `participants_log`

---

## ğŸ”„ Migration & Rollback

### Migration
- Created `ai_participant_import_from_excel` RPC
- Removed all `team_name` column references
- Added `upload_session_id` to `participants_log`

### Rollback
- Revert to `fn_bulk_upload_participants` RPC
- Remove `p_replace` parameter handling

---

## ğŸ“Š Sample Data Flow

**Input Excel** (13 columns):
```
í–‰ì‚¬ëª… | íŒ€ëª… | ë‹´ë‹¹ì ì„±ëª… | ë‹´ë‹¹ì ì—°ë½ì²˜ | ê³ ê° ì„±ëª… | ê±°ë˜ì²˜ëª… | SFE ê±°ë˜ì²˜ì½”ë“œ | SFE ê³ ê°ì½”ë“œ | ê³ ê° ì—°ë½ì²˜ | ë©”ëª¨ | ë‹´ë‹¹ì ì‚¬ë²ˆ | ë“±ë¡ ì¼ì‹œ | ì‚­ì œìœ ë¬´
```

**Processed Data**:
```json
{
  "ê³ ê° ì„±ëª…": "í™ê¸¸ë™",
  "ê±°ë˜ì²˜ëª…": "ì„œìš¸ë³‘ì›",
  "ê³ ê° ì—°ë½ì²˜": "01012345678",
  "íŒ€ëª…": "ì˜ì—…1íŒ€",
  "ë‹´ë‹¹ì ì„±ëª…": "ê¹€ë‹´ë‹¹",
  "ë‹´ë‹¹ì ì—°ë½ì²˜": "01098765432",
  "ë‹´ë‹¹ì ì‚¬ë²ˆ": "EMP001",
  "SFE ê±°ë˜ì²˜ì½”ë“œ": "H123",
  "SFE ê³ ê°ì½”ë“œ": "C456",
  "ë©”ëª¨": "VIP ê³ ê°"
}
```

**Stored in DB**:
```json
{
  "name": "í™ê¸¸ë™",
  "organization": "ì„œìš¸ë³‘ì›",
  "phone": "01012345678",
  "manager_info": {
    "team": "ì˜ì—…1íŒ€",
    "name": "ê¹€ë‹´ë‹¹",
    "phone": "01098765432",
    "emp_id": "EMP001"
  },
  "sfe_hospital_code": "H123",
  "sfe_customer_code": "C456",
  "memo": "VIP ê³ ê°",
  "role_badge": "ì°¸ì„ì",
  "composition": {"adult": 1, "child": 0, "infant": 0}
}
```

---

## âœ… Acceptance Criteria

- [x] Upload with 13 columns only (no extra fields needed)
- [x] No `team_name` column error
- [x] Manager info stored in JSON
- [x] SFE codes handle blank/dash
- [x] Replace mode deletes existing participants
- [x] Update mode merges duplicates
- [x] UI updates immediately
- [x] Toast messages clear and informative

---

## ğŸ‰ Completion Status

**All requirements met. Phase 73-L.2 complete.**

Next phase: TBD (Excel upload system stable)
