# Phase 73-L.2: Excel Upload Layer Rebuild + Replace Mode — COMPLETE ✅

**Tag**: `73-L2.UPLOAD-REBUILD`  
**Branch**: `phase/73-L2-excel-replace`  
**Date**: 2025-10-30

---

## 🎯 Objectives

1. ✅ Fix `column "team_name" does not exist` error permanently
2. ✅ Add Replace mode for Excel upload (delete all existing participants before upload)
3. ✅ Remove "성인/소아/유아 기본값" text from UI
4. ✅ Make "행사명/삭제유무" optional columns
5. ✅ Fix manager info and SFE code handling completely

---

## 🧱 1. Database Changes

### New RPC Function: `ai_participant_import_from_excel`

**Location**: `supabase/migrations/20251030012024_a4cf96b3-4827-46df-827d-1e215d420bb7.sql`

**Key Features**:
- **Replace Mode**: `p_replace` parameter deletes all existing participants before upload
- **No team_name column**: Uses `manager_info` JSON only
- **Auto-mapping**: 13 Korean column headers → standard fields
- **Upsert**: Conflict on `(event_id, phone)` → update existing
- **Default values**: `role_badge='참석자'`, `composition={"adult":1,"child":0,"infant":0}`, etc.
- **Logging**: Records to `participants_log` with session tracking
- **Real-time**: Broadcasts `pg_notify` for instant UI updates

**Signature**:
```sql
ai_participant_import_from_excel(
  p_event_id uuid,
  p_data jsonb,
  p_replace boolean DEFAULT false
) RETURNS jsonb
```

**Return Value**:
```json
{
  "success": true,
  "total": 145,
  "deleted": 0,
  "mode": "merge",
  "event_id": "uuid",
  "agency_id": "uuid",
  "session_id": "excel_1234567890"
}
```

---

## 💻 2. Frontend Changes

### File: `src/components/dashboard/UploadParticipantsModal.tsx`

**Changes**:

1. **Added Replace Mode Toggle**:
   - Two-button selector: "기존 유지 (업데이트)" / "전체 교체 (Replace)"
   - Warning text when Replace mode is active
   - State variable: `replaceMode`

2. **Updated RPC Call**:
   - Changed from `fn_bulk_upload_participants` to `ai_participant_import_from_excel`
   - Passes `p_replace` parameter
   - Simplified data structure (removed individual manager fields)

3. **Revised UI Text**:
   - ✅ Removed: "성인/소아/유아 등은 비워두세요"
   - ✅ Added: "행사명/삭제유무 컬럼은 선택적으로 포함 가능"
   - ✅ Updated: Required fields to "고객 성명, 고객 연락처"

4. **Improved Toast Messages**:
   - Replace mode: "기존 참가자 X명을 삭제하고 새로 Y명을 업로드했습니다."
   - Update mode: "총 X명 처리 완료. 담당자정보·SFE코드 자동 매핑됨."

5. **Preview Section**:
   - Shows first 3 rows (reduced from 5)
   - Displays: name, organization, phone, manager name, SFE codes

---

## 🧪 3. QA Checklist

| # | Test Case | Status |
|---|-----------|--------|
| 1 | Upload 13-column Excel with existing data (Update mode) | ✅ |
| 2 | Upload 13-column Excel with Replace mode | ✅ |
| 3 | `manager_info` JSON created correctly | ✅ |
| 4 | Missing "행사명/삭제유무" columns handled | ✅ |
| 5 | No `team_name` column error | ✅ |
| 6 | UI updates immediately after upload | ✅ |
| 7 | SFE codes with blank/'-' stored as NULL | ✅ |
| 8 | Duplicate phone numbers merged (upsert) | ✅ |

---

## 📦 Deliverables

1. ✅ **Migration**: New RPC function with Replace mode
2. ✅ **Frontend**: Updated upload modal with mode toggle
3. ✅ **UI Text**: Revised instructions (removed adult/child/infant mention)
4. ✅ **Real-time**: SWR cache invalidation after upload
5. ✅ **Logging**: Upload activity tracked in `participants_log`

---

## 🔄 Migration & Rollback

### Migration
- Created `ai_participant_import_from_excel` RPC
- Removed all `team_name` column references
- Added `upload_session_id` to `participants_log`

### Rollback
- Revert to `fn_bulk_upload_participants` RPC
- Remove `p_replace` parameter handling

---

## 📊 Sample Data Flow

**Input Excel** (13 columns):
```
행사명 | 팀명 | 담당자 성명 | 담당자 연락처 | 고객 성명 | 거래처명 | SFE 거래처코드 | SFE 고객코드 | 고객 연락처 | 메모 | 담당자 사번 | 등록 일시 | 삭제유무
```

**Processed Data**:
```json
{
  "고객 성명": "홍길동",
  "거래처명": "서울병원",
  "고객 연락처": "01012345678",
  "팀명": "영업1팀",
  "담당자 성명": "김담당",
  "담당자 연락처": "01098765432",
  "담당자 사번": "EMP001",
  "SFE 거래처코드": "H123",
  "SFE 고객코드": "C456",
  "메모": "VIP 고객"
}
```

**Stored in DB**:
```json
{
  "name": "홍길동",
  "organization": "서울병원",
  "phone": "01012345678",
  "manager_info": {
    "team": "영업1팀",
    "name": "김담당",
    "phone": "01098765432",
    "emp_id": "EMP001"
  },
  "sfe_hospital_code": "H123",
  "sfe_customer_code": "C456",
  "memo": "VIP 고객",
  "role_badge": "참석자",
  "composition": {"adult": 1, "child": 0, "infant": 0}
}
```

---

## ✅ Acceptance Criteria

- [x] Upload with 13 columns only (no extra fields needed)
- [x] No `team_name` column error
- [x] Manager info stored in JSON
- [x] SFE codes handle blank/dash
- [x] Replace mode deletes existing participants
- [x] Update mode merges duplicates
- [x] UI updates immediately
- [x] Toast messages clear and informative

---

## 🎉 Completion Status

**All requirements met. Phase 73-L.2 complete.**

Next phase: TBD (Excel upload system stable)
