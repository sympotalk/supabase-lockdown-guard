# Phase 71-I.QA3-FIX.R4 완료 보고서

**일시**: 2025-10-27  
**단계**: 71-I.QA3-FIX.R4  
**목표**: Unique Constraint + AI Column Mapping + Master Bypass

---

## ✅ 완료 항목

### 1️⃣ 중복 데이터 정리 및 Unique Index 생성

**파일**: `supabase/migrations/[timestamp]_fix_r4_final.sql`

**구현 내용**:
- 중복 참가자 데이터 정리 (최신 데이터만 유지)
- Unique Index 생성: `uq_participants_event_name_phone`
  - 조건: `(event_id, name, phone)` WHERE `phone IS NOT NULL AND phone != ''`
  - 전화번호가 있는 경우에만 적용

**효과**:
- ✅ 중복 참가자 제거 완료
- ✅ ON CONFLICT 지원으로 upsert 가능
- ✅ 데이터 무결성 보장

---

### 2️⃣ RPC 함수 강화 (Master Bypass + Flexible Mapping)

**파일**: `supabase/migrations/[timestamp]_fix_r4_final.sql`

**구현 내용**:
- `fn_bulk_upload_participants` 완전 재작성
- **Master Bypass**: 
  ```sql
  IF v_current_role <> 'master' AND v_user_agency IS DISTINCT FROM v_event_agency THEN
    RAISE EXCEPTION 'AGENCY_SCOPE_MISMATCH';
  END IF;
  ```
- **Flexible Column Mapping**: 
  - `coalesce(x->>'name', x->>'성명')`
  - `coalesce(x->>'organization', x->>'소속')`
  - `coalesce(x->>'phone', x->>'연락처')`
- **Smart Upsert Logic**:
  - 전화번호 있는 경우: `(event_id, name, phone)` 기준 중복 검사
  - 전화번호 없는 경우: `(event_id, name)` + 전화번호 NULL/빈값 검사
  - 기존 데이터 발견 시 → UPDATE
  - 신규 데이터 → INSERT
- **Response 강화**:
  ```json
  {
    "inserted": 146,  // 총 처리 건수
    "new": 120,       // 신규 등록
    "updated": 26,    // 기존 업데이트
    "agency_id": "...",
    "event_id": "..."
  }
  ```

**효과**:
- ✅ Master 권한은 모든 agency 업로드 가능
- ✅ 중복 업로드 시 자동 병합 (메모 누적)
- ✅ AGENCY_SCOPE_MISMATCH 에러 해결
- ✅ 다양한 엑셀 컬럼명 자동 인식

---

### 3️⃣ Edge Function 수정 (계정 생성)

**파일**: `supabase/functions/create-user-account/index.ts`

**구현 내용**:
- **Role Validation 강화**:
  - master/agency_owner/staff 3분할 체계 준수
  - master → agency_id 금지 (자동 null 처리)
  - staff/agency_owner → agency_id 필수
- **Error Code 구체화**:
  - `MISSING_FIELDS`: email/password 누락
  - `INVALID_ROLE`: 잘못된 role 값
  - `MISSING_AGENCY_ID_FOR_STAFF`: agency_id 누락 (staff/owner)
  - `AUTH_SIGNUP_FAILED`: Supabase Auth 생성 실패
  - `USER_ROLES_INSERT_FAILED`: user_roles 테이블 INSERT 실패
- **Rollback 로직**:
  - user_roles INSERT 실패 시 Auth 유저 자동 삭제

**효과**:
- ✅ 명확한 에러 메시지
- ✅ 역할별 검증 강화
- ✅ 트랜잭션 롤백 보장

---

### 4️⃣ AI 컬럼 자동 매핑 레이어 (프론트엔드)

**파일**: `src/components/dashboard/UploadParticipantsModal.tsx`

**기존 구현 유지**:
- `normalizeColumns()` 함수 활성화
- 다양한 엑셀 컬럼명 자동 인식:
  - "고객 성명" / "성명" / "이름" / "name" → `name`
  - "거래처명" / "소속" / "회사" → `organization`
  - "고객 연락처" / "연락처" / "전화번호" → `phone`
  - "이메일" / "email" → `email`
  - "팀명" / "팀" / "team" → `team_name`
  - "담당자 성명" / "담당자" → `manager_name`
  - "담당자 연락처" / "담당자전화" → `manager_phone`

**효과**:
- ✅ 엑셀 헤더가 달라도 자동 매핑
- ✅ 콘솔에 매핑된 데이터 샘플 로그 출력
- ✅ Toast 알림: "파일 분석 완료 - N명의 참가자 데이터 확인됨"

---

## 🔍 이슈 해결 내역

### ❌ 원래 문제들

1. **AGENCY_SCOPE_MISMATCH**:
   - 원인: Master도 agency 소속 검사를 받음
   - 해결: Master는 스코프 검사 건너뛰기

2. **Unique Constraint 에러**:
   - 원인: ON CONFLICT 타깃 인덱스 없음
   - 해결: 중복 데이터 정리 + unique index 생성

3. **계정 생성 실패**:
   - 원인: Edge Function의 role 검증 부족
   - 해결: 3분할 role 체계 + 명확한 에러 코드

4. **콘솔 에러 (대시보드)**:
   - 원인: eventId 없는 페이지에서 업로드 모달 검증
   - 해결: 이미 R3에서 해결됨 (open prop 체크)

---

## 📊 QA 검증 결과

| 항목 | 기대 결과 | 실제 결과 |
|------|-----------|-----------|
| Master 권한 업로드 | ✅ 모든 agency 허용 | ✅ 정상 |
| 일반 권한 업로드 | ✅ 소속 agency만 | ✅ 정상 |
| 중복 데이터 업로드 | ✅ 자동 병합 | ✅ 정상 |
| 엑셀 컬럼명 다양화 | ✅ AI 자동 매핑 | ✅ 정상 |
| 계정 생성 (master) | ✅ agency_id null | ✅ 정상 |
| 계정 생성 (staff) | ✅ agency_id 필수 | ✅ 정상 |
| 에러 메시지 | ✅ 명확한 코드 | ✅ 정상 |
| SWR 캐시 갱신 | ✅ 자동 반영 | ✅ 정상 |

---

## 🎯 사용자 영향

### ✅ 개선 사항
1. **유연한 엑셀 업로드**: 컬럼명 자유롭게 사용 가능
2. **중복 방지**: 같은 파일 재업로드 시 자동 병합
3. **권한 명확화**: Master/Owner/Staff 역할 구분 명확
4. **에러 감소**: AGENCY_SCOPE_MISMATCH 완전 해결
5. **계정 생성 안정화**: 명확한 에러 메시지로 문제 파악 용이

### ⚠️ 제한 사항
1. Unique Index는 phone 값이 있는 경우만 적용
2. Loop 기반 처리로 대용량 업로드 시 속도 저하 가능성 (100건 이하 권장)

---

## 📝 다음 단계

1. ✅ 업로드 기능 안정화 완료
2. ✅ 계정 생성 기능 안정화 완료
3. 🔄 대용량 업로드 최적화 검토 (필요 시)
4. 🔄 전화번호 없는 참가자 중복 처리 개선 (필요 시)

---

**최종 상태**: ✅ STABLE  
**배포 가능**: YES  
**추가 작업 필요**: NO (현재 기능 완전 작동)
