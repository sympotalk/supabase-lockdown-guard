â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  [Phase 71-C.PRECHECK] â€” AGENCY DATA FLOW & POLICY INTEGRITY REPORT
  Generated: 2025-10-26
  Purpose: Cross-role structure validation & participant loading diagnosis
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 1ï¸âƒ£ DATA FLOW TREE (Supabase â†’ Context â†’ Hook â†’ Page â†’ Component)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â”Œâ”€ SUPABASE LAYER
â”‚
â”œâ”€â”€â”€ Tables/Views
â”‚    â”œâ”€â”€ events (RLS: âœ… Master + Agency scoped)
â”‚    â”œâ”€â”€ participants (RLS: âš ï¸ NOT EXPLICITLY DEFINED)
â”‚    â”œâ”€â”€ event_progress_view (RLS: âš ï¸ NOT EXPLICITLY DEFINED)
â”‚    â”œâ”€â”€ agencies
â”‚    â”œâ”€â”€ user_roles
â”‚    â”œâ”€â”€ agency_members
â”‚    â”œâ”€â”€ rooming
â”‚    â””â”€â”€ messages
â”‚
â”œâ”€â”€â”€ RPC Functions
â”‚    â”œâ”€â”€ fn_bulk_upload_participants (agency_id check required)
â”‚    â”œâ”€â”€ rpc_invite_user
â”‚    â”œâ”€â”€ rpc_create_agency
â”‚    â””â”€â”€ master_* functions (master role required)
â”‚
â””â”€â”€â”€ Views
     â”œâ”€â”€ event_progress_view (agency_id column present)
     â””â”€â”€ agency_summary

â”Œâ”€ CONTEXT LAYER
â”‚
â”œâ”€â”€â”€ UserContext.tsx [SHARED: âœ…]
â”‚    â”œâ”€â”€ Provides: role, agencyScope, userId, user, session
â”‚    â”œâ”€â”€ Used by: ALL pages
â”‚    â””â”€â”€ Manages: Session sync, role determination, agency scope
â”‚
â”œâ”€â”€â”€ AppDataContext.tsx [âš ï¸ MIXED MASTER/AGENCY LOGIC]
â”‚    â”œâ”€â”€ Provides: profile, agency, agencyList, metrics
â”‚    â”œâ”€â”€ Used by: CreateEventModal, admin pages
â”‚    â”œâ”€â”€ Issues:
â”‚    â”‚   â€¢ Mixes master and agency data fetching
â”‚    â”‚   â€¢ Loads all agencies for master
â”‚    â”‚   â€¢ Realtime subscriptions to agency-specific tables
â”‚    â””â”€â”€ Dependencies: UserContext
â”‚
â””â”€â”€â”€ MasterContext.tsx [MASTER ONLY: âœ…]
     â”œâ”€â”€ Provides: metrics, aiInsights, qaReports
     â”œâ”€â”€ Used by: MasterLayout, master/* pages
     â”œâ”€â”€ Dependencies: useMasterData hooks
     â””â”€â”€ Scope: Master dashboard only

â”Œâ”€ HOOK LAYER
â”‚
â”œâ”€â”€â”€ useAgencyDashboard.ts [AGENCY ONLY]
â”‚    â”œâ”€â”€ Functions:
â”‚    â”‚   â€¢ useEventProgress() â†’ event_progress_view
â”‚    â”‚   â€¢ useEventCounts() â†’ events table
â”‚    â”œâ”€â”€ SWR Keys:
â”‚    â”‚   â€¢ 'event_progress_view' [âš ï¸ NO AGENCY SCOPE IN KEY]
â”‚    â”‚   â€¢ 'event_counts' [âš ï¸ NO AGENCY SCOPE IN KEY]
â”‚    â”œâ”€â”€ RLS Filter: âš ï¸ Relies on DB-level RLS only
â”‚    â””â”€â”€ Used by: /admin/dashboard
â”‚
â”œâ”€â”€â”€ useMasterData.ts [MASTER ONLY]
â”‚    â”œâ”€â”€ Functions:
â”‚    â”‚   â€¢ useSystemMetrics() â†’ master metrics
â”‚    â”‚   â€¢ useAIInsights() â†’ ai_insights table
â”‚    â”‚   â€¢ useQAReports() â†’ qa_reports table
â”‚    â”œâ”€â”€ SWR Keys: 'master:*' prefix
â”‚    â””â”€â”€ Used by: MasterContext
â”‚
â”œâ”€â”€â”€ useUnifiedParticipant.ts [SHARED: âš ï¸]
â”‚    â”œâ”€â”€ Parameters: eventId, agencyId
â”‚    â”œâ”€â”€ Query: participants table
â”‚    â”œâ”€â”€ Issues:
â”‚    â”‚   â€¢ Requires BOTH eventId AND agencyId
â”‚    â”‚   â€¢ Returns empty if neither provided
â”‚    â”‚   â€¢ No RLS policy verification
â”‚    â”œâ”€â”€ Realtime: Subscribes to participants, rooming, messages
â”‚    â””â”€â”€ Used by: /admin/participants
â”‚
â””â”€â”€â”€ useAppData() [âš ï¸ MIXED]
     â”œâ”€â”€ From: AppDataContext
     â”œâ”€â”€ Returns: profile, agency, metrics
     â””â”€â”€ Mixed master/agency logic

â”Œâ”€ PAGE LAYER
â”‚
â”œâ”€â”€â”€ /admin/dashboard (Dashboard.tsx) [AGENCY]
â”‚    â”œâ”€â”€ Context: useUser (agencyScope required for master)
â”‚    â”œâ”€â”€ Hooks: useEventProgress, useEventCounts
â”‚    â”œâ”€â”€ Components: UploadParticipantsModal, CreateEventModal
â”‚    â”œâ”€â”€ Data:
â”‚    â”‚   â€¢ Event progress with rooming rates
â”‚    â”‚   â€¢ Event counts by status
â”‚    â”œâ”€â”€ RLS Check: âš ï¸ event_progress_view has no explicit RLS
â”‚    â””â”€â”€ Issue: Master without agencyScope sees nothing
â”‚
â”œâ”€â”€â”€ /admin/participants (Participants.tsx) [AGENCY]
â”‚    â”œâ”€â”€ Context: useUser (agencyScope, setAgencyScope)
â”‚    â”œâ”€â”€ Hooks: useUnifiedParticipant(eventId, agencyScope)
â”‚    â”œâ”€â”€ Query Params: Syncs ?agency= param to agencyScope
â”‚    â”œâ”€â”€ Data:
â”‚    â”‚   â€¢ Participants list
â”‚    â”‚   â€¢ Filtered by eventId or agencyId
â”‚    â”œâ”€â”€ RLS Check: âš ï¸ participants table has no explicit RLS
â”‚    â”œâ”€â”€ Issue: ğŸš« NULL DATA when agencyScope missing
â”‚    â””â”€â”€ Loading: Shows spinner correctly
â”‚
â”œâ”€â”€â”€ /admin/events (Events.tsx) [AGENCY]
â”‚    â”œâ”€â”€ Context: useUser (role, agencyScope, setAgencyScope)
â”‚    â”œâ”€â”€ Query: Direct supabase.from('events')
â”‚    â”œâ”€â”€ RLS Filter:
â”‚    â”‚   â€¢ Master: All events OR filtered by agencyScope
â”‚    â”‚   â€¢ Agency: Filtered by agencyScope
â”‚    â”œâ”€â”€ RLS Check: âœ… events table has proper RLS
â”‚    â””â”€â”€ Issue: Works correctly
â”‚
â””â”€â”€â”€ /agency/:id (AgencyView.tsx) [INFO PAGE]
     â”œâ”€â”€ Context: useUser (setAgencyScope)
     â”œâ”€â”€ Query: agencies table
     â”œâ”€â”€ Action: "ì—ì´ì „ì‹œ ëŒ€ì‹œë³´ë“œ ë³´ê¸°" button
     â”‚   â†’ setAgencyScope(agency.id)
     â”‚   â†’ navigate('/admin/dashboard')
     â””â”€â”€ Purpose: Master views agency info before entering

â”Œâ”€ LAYOUT LAYER
â”‚
â”œâ”€â”€â”€ AdminLayout
â”‚    â”œâ”€â”€ Components: Header + Sidebar
â”‚    â”œâ”€â”€ Routes: /admin/*
â”‚    â””â”€â”€ Used by: agency_owner, staff, master (with agencyScope)
â”‚
â”œâ”€â”€â”€ MasterLayout
â”‚    â”œâ”€â”€ Components: MasterHeader + MasterSidebar
â”‚    â”œâ”€â”€ Routes: /master/*
â”‚    â”œâ”€â”€ Auto-clear: setAgencyScope(null) on /master/* routes
â”‚    â””â”€â”€ Used by: master only
â”‚
â”œâ”€â”€â”€ Header.tsx [ADMIN]
â”‚    â”œâ”€â”€ Badge: Shows when master + agencyScope + /admin/*
â”‚    â”œâ”€â”€ Exit Button: setAgencyScope(null) â†’ /master/dashboard
â”‚    â””â”€â”€ Issue: ğŸš« Badge conditional may fail if agencyName not loaded
â”‚
â””â”€â”€â”€ MasterHeader.tsx [MASTER]
     â”œâ”€â”€ Badge: "ì—ì´ì „ì‹œ ë·° Â· {name}"
     â”œâ”€â”€ Condition: isAgencyView = (role=master && agencyScope) || (role=agency_owner && agencyScope)
     â”œâ”€â”€ Query: agency_summary table
     â””â”€â”€ Fallback: "(ì•Œ ìˆ˜ ì—†ìŒ)" if name not loaded

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 2ï¸âƒ£ PAGE FILE DEPENDENCY MATRIX
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Page                â”‚ Dependencies                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ /admin/dashboard    â”‚ Context: UserContext                                â”‚
â”‚ (Dashboard.tsx)     â”‚ Hooks: useEventProgress, useEventCounts (SWR)       â”‚
â”‚                     â”‚ Components: UploadParticipantsModal, CreateEventModalâ”‚
â”‚                     â”‚ Supabase: event_progress_view, events table         â”‚
â”‚                     â”‚ RLS: âš ï¸ event_progress_view (NOT DEFINED)           â”‚
â”‚                     â”‚ Issue: Master needs agencyScope                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ /admin/participants â”‚ Context: UserContext                                â”‚
â”‚ (Participants.tsx)  â”‚ Hooks: useUnifiedParticipant(eventId, agencyScope)  â”‚
â”‚                     â”‚ Components: ModuleInsightBar, LoadingSkeleton       â”‚
â”‚                     â”‚ Supabase: participants table, events (for filter)   â”‚
â”‚                     â”‚ RLS: âš ï¸ participants (NOT DEFINED)                  â”‚
â”‚                     â”‚ Issue: ğŸš« Returns [] when agencyScope=null         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ /admin/events       â”‚ Context: UserContext                                â”‚
â”‚ (Events.tsx)        â”‚ Hooks: None (direct query)                          â”‚
â”‚                     â”‚ Components: CreateEventModal, StatusBadge           â”‚
â”‚                     â”‚ Supabase: events table (direct SELECT)              â”‚
â”‚                     â”‚ RLS: âœ… events (DEFINED)                            â”‚
â”‚                     â”‚ Filter: Manual .eq('agency_id', agencyScope)        â”‚
â”‚                     â”‚ Issue: None                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ /agency/:id         â”‚ Context: UserContext (setAgencyScope)               â”‚
â”‚ (AgencyView.tsx)    â”‚ Hooks: None (direct query)                          â”‚
â”‚                     â”‚ Components: Card, Badge, Button                     â”‚
â”‚                     â”‚ Supabase: agencies table                            â”‚
â”‚                     â”‚ Purpose: Info page + dashboard entry button         â”‚
â”‚                     â”‚ Issue: None                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SUPABASE TABLE/VIEW ACCESS:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Resource             â”‚ RLS Enabled  â”‚ Policy Scope â”‚ Accessed By         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ events               â”‚ âœ… Yes       â”‚ âœ… DEFINED   â”‚ Dashboard, Events   â”‚
â”‚ participants         â”‚ âš ï¸ Unknown   â”‚ âš ï¸ MISSING   â”‚ Participants        â”‚
â”‚ event_progress_view  â”‚ âš ï¸ Unknown   â”‚ âš ï¸ MISSING   â”‚ Dashboard           â”‚
â”‚ agencies             â”‚ âœ… Yes       â”‚ âœ… DEFINED   â”‚ AgencyView, Headers â”‚
â”‚ agency_summary       â”‚ âš ï¸ Unknown   â”‚ âš ï¸ MISSING   â”‚ MasterHeader        â”‚
â”‚ user_roles           â”‚ âœ… Yes       â”‚ âœ… DEFINED   â”‚ UserContext         â”‚
â”‚ rooming              â”‚ âš ï¸ Unknown   â”‚ âš ï¸ MISSING   â”‚ useUnifiedParticipantâ”‚
â”‚ messages             â”‚ âš ï¸ Unknown   â”‚ âš ï¸ MISSING   â”‚ useUnifiedParticipantâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 3ï¸âƒ£ ROLE-BASED ACCESS CONTROL MATRIX
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ROLE: master
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Action              â”‚ Access   â”‚ Notes                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ /master/dashboard   â”‚ âœ…       â”‚ MasterContext provides data            â”‚
â”‚ /master/agencies    â”‚ âœ…       â”‚ List all agencies                      â”‚
â”‚ /admin/dashboard    â”‚ âš ï¸       â”‚ Requires agencyScope to be set         â”‚
â”‚ /admin/participants â”‚ âš ï¸       â”‚ Requires agencyScope + eventId         â”‚
â”‚ /admin/events       â”‚ âš ï¸       â”‚ Works with agencyScope filter          â”‚
â”‚ Create Event        â”‚ âœ…       â”‚ Can select any agency                  â”‚
â”‚ Upload Participants â”‚ âš ï¸       â”‚ Needs agencyScope for RPC validation   â”‚
â”‚ RPC: master_*       â”‚ âœ…       â”‚ has_role check passes                  â”‚
â”‚ View all data       â”‚ âœ…       â”‚ RLS policies allow                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ROLE: agency_owner
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Action              â”‚ Access   â”‚ Notes                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ /master/*           â”‚ ğŸš«       â”‚ MasterLayout redirects to /admin       â”‚
â”‚ /admin/dashboard    â”‚ âœ…       â”‚ agencyScope auto-set from user_roles   â”‚
â”‚ /admin/participants â”‚ âœ…       â”‚ agencyScope available                  â”‚
â”‚ /admin/events       â”‚ âœ…       â”‚ Filtered by agency_id                  â”‚
â”‚ Create Event        â”‚ âœ…       â”‚ agency_id auto-set                     â”‚
â”‚ Upload Participants â”‚ âœ…       â”‚ agency_id available                    â”‚
â”‚ RPC: master_*       â”‚ ğŸš«       â”‚ has_role check fails                   â”‚
â”‚ View own agency     â”‚ âœ…       â”‚ RLS policies filter correctly          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ROLE: staff
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Action              â”‚ Access   â”‚ Notes                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ /master/*           â”‚ ğŸš«       â”‚ Redirected to /admin                   â”‚
â”‚ /admin/dashboard    â”‚ âœ…       â”‚ agencyScope auto-set                   â”‚
â”‚ /admin/participants â”‚ âœ…       â”‚ Can view/edit                          â”‚
â”‚ /admin/events       â”‚ âœ…       â”‚ Can view/create                        â”‚
â”‚ Create Event        â”‚ âœ…       â”‚ [71-B] Staff can create events         â”‚
â”‚ Upload Participants â”‚ âœ…       â”‚ [71-B] Staff can upload                â”‚
â”‚ RPC: master_*       â”‚ ğŸš«       â”‚ Insufficient permissions               â”‚
â”‚ View own agency     â”‚ âœ…       â”‚ Filtered correctly                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RLS POLICY MAPPING:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Table/View          â”‚ Policy       â”‚ Logic                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ events              â”‚ âœ… DEFINED   â”‚ Master: ALL                         â”‚
â”‚                     â”‚              â”‚ Agency: WHERE agency_id=user.agency â”‚
â”‚ participants        â”‚ âš ï¸ MISSING   â”‚ ğŸš« NO RLS DEFINED                   â”‚
â”‚ event_progress_view â”‚ âš ï¸ MISSING   â”‚ ğŸš« NO RLS DEFINED                   â”‚
â”‚ agencies            â”‚ âœ… DEFINED   â”‚ Master: ALL, Agency: Own            â”‚
â”‚ user_roles          â”‚ âœ… DEFINED   â”‚ Self + Master                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SHARED RESOURCE CONFLICTS:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸš« SWR Key Collision:                                                   â”‚
â”‚    â€¢ useEventProgress() â†’ key: 'event_progress_view'                    â”‚
â”‚    â€¢ useEventCounts() â†’ key: 'event_counts'                             â”‚
â”‚    â€¢ Problem: No agency_id in key â†’ master cache collision              â”‚
â”‚    â€¢ Solution: Add agencyScope to SWR key                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âš ï¸ AppDataContext Mixed Logic:                                          â”‚
â”‚    â€¢ Loads agencyList for master                                        â”‚
â”‚    â€¢ Subscribes to agency-specific realtime                             â”‚
â”‚    â€¢ Mixes master/agency metrics fetching                               â”‚
â”‚    â€¢ Solution: Split into MasterDataContext + AgencyDataContext         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âš ï¸ useUnifiedParticipant:                                               â”‚
â”‚    â€¢ Requires eventId OR agencyId                                       â”‚
â”‚    â€¢ Returns [] if both null                                            â”‚
â”‚    â€¢ Used by Participants page                                          â”‚
â”‚    â€¢ Problem: Master without agencyScope â†’ empty list                   â”‚
â”‚    â€¢ Solution: Force agencyScope selection before loading               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 4ï¸âƒ£ DATA SCOPE POLICY BY MENU
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

/admin/dashboard
â”œâ”€â”€ Expected Scope: agency_id = agencyScope
â”œâ”€â”€ Data Sources:
â”‚   â€¢ event_progress_view (âš ï¸ No RLS â†’ relies on DB-level filter)
â”‚   â€¢ events table (âœ… RLS enforced)
â”œâ”€â”€ Filter Logic:
â”‚   â€¢ useEventProgress: SELECT * FROM event_progress_view
â”‚   â€¢ useEventCounts: SELECT status FROM events WHERE is_active=true
â”œâ”€â”€ Issue: ğŸš« Master without agencyScope sees ALL data (unsafe)
â””â”€â”€ Fix Required: Add RLS policy to event_progress_view

/admin/participants
â”œâ”€â”€ Expected Scope: agency_id = agencyScope + optional event_id filter
â”œâ”€â”€ Data Sources:
â”‚   â€¢ participants table (âš ï¸ No RLS)
â”‚   â€¢ events table (for dropdown filter)
â”œâ”€â”€ Filter Logic:
â”‚   â€¢ useUnifiedParticipant:
â”‚     - .eq('event_id', eventId) if eventId
â”‚     - .eq('agency_id', agencyId) if agencyId
â”‚     - Returns [] if both null
â”œâ”€â”€ Issue: ğŸš« If agencyScope=null â†’ empty list + "ë“±ë¡ëœ ì°¸ê°€ì ì—†ìŒ"
â””â”€â”€ Fix Required:
    1. Add RLS to participants table
    2. Enforce agencyScope before page load

/admin/events
â”œâ”€â”€ Expected Scope: agency_id = agencyScope
â”œâ”€â”€ Data Sources:
â”‚   â€¢ events table (âœ… RLS enforced)
â”œâ”€â”€ Filter Logic:
â”‚   â€¢ Direct query:
â”‚     - Master without scope: All events
â”‚     - Master with scope: .eq('agency_id', agencyScope)
â”‚     - Agency users: Auto-filtered by RLS
â”œâ”€â”€ Issue: âœ… None (works correctly)
â””â”€â”€ Status: SAFE

/agency/:id (Info Page)
â”œâ”€â”€ Expected Scope: No filtering (view single agency record)
â”œâ”€â”€ Data Sources:
â”‚   â€¢ agencies table (âœ… RLS enforced)
â”œâ”€â”€ Purpose: View agency info before entering dashboard
â”œâ”€â”€ Action Button:
â”‚   â€¢ setAgencyScope(agency.id)
â”‚   â€¢ navigate('/admin/dashboard')
â”œâ”€â”€ Issue: âœ… None
â””â”€â”€ Status: SAFE

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 5ï¸âƒ£ PARTICIPANT PAGE LOADING ERROR ROOT CAUSE ANALYSIS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ” SYMPTOM:
   â€¢ Participants page shows "ë“±ë¡ëœ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤" message
   â€¢ No data appears even when participants exist
   â€¢ Loading spinner may appear briefly then disappear

ğŸ” TRIGGER CHAIN:

1ï¸âƒ£ User enters /admin/participants
   â””â”€> AdminLayout renders
       â””â”€> Participants.tsx mounts

2ï¸âƒ£ Participants.tsx initialization:
   â”œâ”€> const { role, agencyScope, setAgencyScope } = useUser();
   â”œâ”€> const [selectedEventId, setSelectedEventId] = useState<string | null>(null);
   â””â”€> const { data, loading, refresh } = useUnifiedParticipant(selectedEventId, agencyScope);

3ï¸âƒ£ useUnifiedParticipant.ts execution:
   â”œâ”€> const load = async () => {
   â”‚     if (!eventId && !agencyId) {
   â”‚       console.warn("[useUnifiedParticipant] Skipped loading â€” no eventId or agencyId provided");
   â”‚       setData([]);
   â”‚       setLoading(false);
   â”‚       return;  â† ğŸš« EARLY RETURN HERE
   â”‚     }
   â”‚   }
   â””â”€> If both null â†’ returns empty array immediately

4ï¸âƒ£ Component renders:
   â””â”€> {participants.length === 0 ? (
         <div>ë“±ë¡ëœ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤...</div>  â† ğŸš« THIS MESSAGE SHOWN
       ) : (...)}

ğŸ” ROOT CAUSES:

PRIMARY CAUSE: Missing agencyScope
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Scenario: Master enters /admin/participants without setting agencyScopeâ”‚
â”‚ Result: useUnifiedParticipant receives (null, null)                    â”‚
â”‚ Behavior: Early return with empty array                                â”‚
â”‚ UI: "ë“±ë¡ëœ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤" message                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SECONDARY CAUSE: URL Sync Delay
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Code (Lines 40-46 in Participants.tsx):                                â”‚
â”‚   useEffect(() => {                                                     â”‚
â”‚     const agencyParam = searchParams.get("agency");                     â”‚
â”‚     if (agencyParam && agencyParam !== agencyScope) {                   â”‚
â”‚       setAgencyScope(agencyParam);  â† Async state update                â”‚
â”‚     }                                                                    â”‚
â”‚   }, [searchParams, agencyScope, setAgencyScope]);                      â”‚
â”‚                                                                          â”‚
â”‚ Problem: setAgencyScope is async â†’ first render has null               â”‚
â”‚ Result: useUnifiedParticipant runs with null before update             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TERTIARY CAUSE: No Guard at Page Level
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Code (Lines 71-80 in Participants.tsx):                                â”‚
â”‚   if (role === "master" && !agencyScope) {                             â”‚
â”‚     return (                                                            â”‚
â”‚       <div>ë¨¼ì € ì—ì´ì „ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>                           â”‚
â”‚     );                                                                  â”‚
â”‚   }                                                                     â”‚
â”‚                                                                          â”‚
â”‚ Issue: Guard exists BUT only for master                                â”‚
â”‚ Gap: If agency_owner/staff has no agencyScope â†’ no guard               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

QUATERNARY CAUSE: Missing RLS Policy
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Table: participants                                                     â”‚
â”‚ RLS Status: âš ï¸ NOT EXPLICITLY DEFINED                                  â”‚
â”‚                                                                          â”‚
â”‚ Risk: If RLS disabled â†’ cross-agency data leak                         â”‚
â”‚ Current: Relies on application-level filtering only                    â”‚
â”‚                                                                          â”‚
â”‚ Expected Policy:                                                        â”‚
â”‚   CREATE POLICY "Agency users view own participants"                   â”‚
â”‚   ON participants FOR SELECT                                            â”‚
â”‚   USING (                                                               â”‚
â”‚     has_role(auth.uid(), 'master') OR                                   â”‚
â”‚     agency_id IN (                                                      â”‚
â”‚       SELECT agency_id FROM user_roles                                  â”‚
â”‚       WHERE user_id = auth.uid()                                        â”‚
â”‚     )                                                                   â”‚
â”‚   );                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ” CALL STACK AT ERROR:

/admin/participants
  â†“
Participants.tsx (mount)
  â†“
const { agencyScope } = useUser()  â† Returns null initially
  â†“
useUnifiedParticipant(null, null)
  â†“
load() function
  â†“
if (!eventId && !agencyId) { return; }  â† ğŸš« EARLY EXIT
  â†“
setData([])
setLoading(false)
  â†“
Component renders with empty array
  â†“
{participants.length === 0 ? "ë“±ë¡ëœ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤" : ...}

ğŸ” TIMING DIAGRAM:

T=0ms    Page mounts
         â”œâ”€> UserContext: agencyScope = null (initial)
         â””â”€> useUnifiedParticipant(null, null)
             â””â”€> Returns [] immediately

T=50ms   URL sync useEffect runs
         â””â”€> Reads ?agency=xyz from URL
             â””â”€> setAgencyScope(xyz) called

T=100ms  UserContext updates
         â””â”€> agencyScope = xyz now

T=150ms  useUnifiedParticipant detects change
         â””â”€> Runs load() with new agencyScope
             â””â”€> Fetches participants
                 â””â”€> Data appears âœ…

Problem: Between T=0 and T=150ms â†’ User sees "no data" message

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 6ï¸âƒ£ CRITICAL ISSUES SUMMARY
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸš¨ HIGH PRIORITY

1. Missing RLS Policies
   â”œâ”€ participants table: NO POLICY DEFINED
   â”œâ”€ event_progress_view: NO POLICY DEFINED
   â”œâ”€ rooming table: NO POLICY DEFINED
   â””â”€ messages table: NO POLICY DEFINED
   
   Risk: Cross-agency data exposure
   Impact: Security vulnerability
   Fix: Add RLS policies for all agency-scoped tables

2. SWR Cache Key Collision
   â”œâ”€ useEventProgress: key = 'event_progress_view'
   â””â”€ useEventCounts: key = 'event_counts'
   
   Problem: No agencyScope in key â†’ master views wrong data
   Impact: Data confusion between agencies
   Fix: Include agencyScope in SWR keys

3. useUnifiedParticipant Empty Return
   â”œâ”€ Returns [] if no eventId/agencyId
   â”œâ”€ No loading indicator during sync
   â””â”€ Master sees "no data" message
   
   Problem: Poor UX, confusing error state
   Impact: Users think data is missing
   Fix: Show loading state until scope is set

âš ï¸ MEDIUM PRIORITY

4. AppDataContext Mixed Logic
   â”œâ”€ Handles both master and agency data
   â”œâ”€ Subscribes to agency-specific realtime
   â””â”€ Complex conditional logic
   
   Problem: Hard to maintain, error-prone
   Impact: Future bugs likely
   Fix: Split into MasterDataContext + AgencyDataContext

5. URL Sync Delay
   â”œâ”€ Participants.tsx syncs ?agency= param
   â”œâ”€ Async setAgencyScope causes timing gap
   â””â”€ First render shows empty state
   
   Problem: Flickering UI, "no data" flash
   Impact: Poor UX
   Fix: Block render until agencyScope is ready

6. Master Dashboard Without Scope
   â”œâ”€ /admin/dashboard requires agencyScope
   â”œâ”€ Master without scope sees nothing
   â””â”€ No clear instruction to select agency
   
   Problem: Confusing empty state
   Impact: Users don't know what to do
   Fix: Add "Select Agency" prompt like Participants page

ğŸ“‹ LOW PRIORITY

7. Badge Visibility Logic
   â”œâ”€ MasterHeader checks agencyScope && currentAgencyName
   â”œâ”€ Header checks agencyScope && agencyName && /admin/*
   â””â”€ Fallback: "(ì•Œ ìˆ˜ ì—†ìŒ)" added
   
   Status: Recently fixed in Phase 3.14-D.AGENCYVIEW.FIX.2
   Impact: Minimal

8. CreateEventModal Agency Selection
   â”œâ”€ Master selects from dropdown
   â”œâ”€ Agency users have agency_id auto-set
   â””â”€ Uses AppDataContext (mixed logic)
   
   Issue: Depends on AppDataContext refactor
   Impact: Works but could be cleaner

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 7ï¸âƒ£ RECOMMENDED FIX SEQUENCE (Phase 71-D)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

STEP 1: DATABASE LAYER (Supabase RLS Policies)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Priority: ğŸš¨ CRITICAL
Files: supabase/migrations/new_migration.sql

Actions:
â”œâ”€ Add RLS policy to participants table
â”œâ”€ Add RLS policy to event_progress_view
â”œâ”€ Add RLS policy to rooming table
â”œâ”€ Add RLS policy to messages table
â””â”€ Verify all agency-scoped tables have RLS

SQL Template:
```sql
-- Participants RLS
ALTER TABLE participants ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Master views all participants"
ON participants FOR SELECT
USING (has_role(auth.uid(), 'master'::app_role));

CREATE POLICY "Agency users view own participants"
ON participants FOR SELECT
USING (
  agency_id IN (
    SELECT agency_id FROM user_roles
    WHERE user_id = auth.uid()
  )
);

-- Repeat for other tables...
```

STEP 2: HOOK LAYER (Fix SWR Cache Keys)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Priority: ğŸš¨ HIGH
Files: src/hooks/useAgencyDashboard.ts

Changes:
â”œâ”€ Add agencyScope parameter to all hooks
â”œâ”€ Include agencyScope in SWR keys
â””â”€ Filter queries by agencyScope at DB level

Before:
```typescript
useSWR('event_progress_view', ...)
```

After:
```typescript
useSWR(
  agencyScope ? `event_progress_view:${agencyScope}` : null,
  async () => {
    return supabase
      .from('event_progress_view')
      .select('*')
      .eq('agency_id', agencyScope)
      ...
  }
)
```

STEP 3: PARTICIPANTS PAGE (Fix Empty State)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Priority: ğŸš¨ HIGH
Files: src/pages/admin/Participants.tsx
       src/hooks/useUnifiedParticipant.ts

Changes:
â”œâ”€ Block render until agencyScope is set
â”œâ”€ Show loading state during URL sync
â”œâ”€ Add fallback for missing scope
â””â”€ Improve error messaging

Pseudocode:
```typescript
// Participants.tsx
if (loading || !agencyScope) {
  return <LoadingSkeleton message="ì—ì´ì „ì‹œ ì •ë³´ ë¡œë”© ì¤‘..." />;
}

// useUnifiedParticipant.ts
if (!eventId && !agencyId) {
  setLoading(true); // Keep loading state
  return; // Wait for scope
}
```

STEP 4: DASHBOARD PAGE (Add Agency Guard)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Priority: âš ï¸ MEDIUM
Files: src/pages/admin/Dashboard.tsx

Changes:
â”œâ”€ Add guard for master without agencyScope
â”œâ”€ Show "Select Agency" prompt
â””â”€ Match Participants page pattern

Code:
```typescript
if (role === 'master' && !agencyScope) {
  return (
    <EmptyState
      title="ì—ì´ì „ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”"
      description="ë¨¼ì € ì—ì´ì „ì‹œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."
      action={<Button onClick={() => navigate('/master/agencies')}>
        ì—ì´ì „ì‹œ ëª©ë¡
      </Button>}
    />
  );
}
```

STEP 5: CONTEXT REFACTOR (Split AppDataContext)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Priority: âš ï¸ MEDIUM (can defer to Phase 71-E)
Files: src/contexts/AgencyDataContext.tsx (new)
       src/contexts/MasterDataContext.tsx (exists)

Changes:
â”œâ”€ Create dedicated AgencyDataContext
â”œâ”€ Move agency-specific logic from AppDataContext
â”œâ”€ Keep MasterContext for master-only data
â””â”€ Update all consumers

Structure:
```
MasterContext (exists)
  â””â”€ Master dashboard metrics, AI insights, QA reports

AgencyDataContext (new)
  â””â”€ Agency events, participants, metrics

UserContext (keep)
  â””â”€ Auth, role, agencyScope
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 8ï¸âƒ£ VERIFICATION CHECKLIST (Post-Fix QA)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â–¡ RLS POLICIES
  â–¡ participants table has RLS enabled and policies defined
  â–¡ event_progress_view has RLS policies
  â–¡ rooming table has RLS policies
  â–¡ messages table has RLS policies
  â–¡ Test: Master cannot see other agency data when agencyScope is set
  â–¡ Test: Agency users cannot see other agency data

â–¡ SWR CACHE
  â–¡ useEventProgress includes agencyScope in key
  â–¡ useEventCounts includes agencyScope in key
  â–¡ Test: Master switching between agencies sees correct cached data
  â–¡ Test: No cache collision between agencies

â–¡ PARTICIPANTS PAGE
  â–¡ Shows loading state until agencyScope is ready
  â–¡ Empty state only when no participants exist (not missing scope)
  â–¡ Master without agencyScope sees "Select Agency" message
  â–¡ URL ?agency= param syncs to agencyScope correctly
  â–¡ Test: Navigate from master agencies â†’ participants works
  â–¡ Test: Direct URL /admin/participants?agency=xyz works
  â–¡ Test: Refresh page maintains agencyScope

â–¡ DASHBOARD PAGE
  â–¡ Master without agencyScope sees "Select Agency" prompt
  â–¡ Agency users see data immediately
  â–¡ event_progress_view shows correct agency data only
  â–¡ Test: Master enters from /master/agencies â†’ dashboard works
  â–¡ Test: Agency owner sees only own events

â–¡ NAVIGATION FLOW
  â–¡ Master: /master/agencies â†’ click agency â†’ /admin/dashboard works
  â–¡ Master: "ì—ì´ì „ì‹œ ë·°" badge appears correctly
  â–¡ Master: "Exit View Mode" clears scope and returns to /master
  â–¡ Agency users: Direct /admin/dashboard access works
  â–¡ Test: All navigation paths set/clear agencyScope correctly

â–¡ ERROR HANDLING
  â–¡ Missing agencyScope shows clear user message
  â–¡ Empty data shows "no data" (not error state)
  â–¡ RLS denial shows permission error
  â–¡ Network errors show retry option

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 END OF REPORT
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Next Steps:
1. ì„¤ê³„íŒ€ì¥: Review issues marked with ğŸš« and âš ï¸
2. ê²€ìˆ˜íŒ€ì¥: Prioritize fixes based on STEP 1-5 sequence
3. Phase 71-D: Execute database + hook layer fixes first
4. Phase 71-E: Context refactor + final polish

Log: [71-C.PRECHECK] Full Agency Data Flow & Policy Integrity Report completed.
