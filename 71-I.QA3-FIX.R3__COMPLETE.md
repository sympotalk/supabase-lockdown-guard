# Phase 71-I.QA3-FIX.R3: Schema Sync + Upload Guard Hotfix ✅

## 목표
옵션 B로 진행 - 기존 스키마(`name`, `organization`, `phone`)에 맞게 RPC와 프론트엔드 수정

## 완료된 작업

### 1️⃣ UploadParticipantsModal.tsx 수정
- **useEffect 가드**: 모달이 `open` 상태일 때만 eventId 검증 실행
  - 대시보드 접속 시 `[71-I.QA3] ⚠️ eventId not found in route` 에러 해결
- **Excel 파싱**: 기존 DB 스키마에 맞게 매핑
  - `participant_name` → `name`
  - `company_name` → `organization`
  - `participant_contact` → `phone`
  - `team_name`, `manager_name`, `manager_phone` 직접 매핑
- **SFE 코드, 숙박예정 제거**: DB에 없는 컬럼 제거

### 2️⃣ RPC 함수 수정 (fn_bulk_upload_participants)
```sql
-- 기존 스키마 컬럼 사용
insert into participants(
  event_id, agency_id,
  name, organization, phone, email,
  memo, team_name, manager_name, manager_phone,
  created_by
)
-- on conflict (event_id, name, phone)
```
- `participant_name`, `company_name`, `participant_contact` 제거
- `sfe_agency_code`, `sfe_customer_code`, `stay_plan` 제거
- 마스터 권한 사용자는 AGENCY_SCOPE_MISMATCH 예외 허용

### 3️⃣ ParticipantsPanel.tsx 수정
- **Participant 인터페이스**: 기존 스키마에 맞게 수정
  ```typescript
  interface Participant {
    id: string;
    name: string;
    organization?: string;
    phone?: string;
    team_name?: string;
    manager_name?: string;
    manager_phone?: string;
    ...
  }
  ```
- **데이터 로딩**: 직접 매핑 제거, DB 스키마 그대로 사용
- **테이블 렌더링**: `participant_name` → `name`, `company_name` → `organization`, `participant_contact` → `phone`
- **테이블 헤더**: "숙박예정" → "팀명"

### 4️⃣ ParticipantRightPanel.tsx 수정
- **Participant 인터페이스**: 기존 스키마에 맞게 수정
- **기본 정보 표시**: `name`, `organization`, `phone` 사용
- **담당자 정보**: `manager_info` jsonb 대신 `team_name`, `manager_name`, `manager_phone` 직접 사용
- **숙박예정 섹션 제거**: DB에 없는 컬럼
- **SFE 코드 섹션 제거**: DB에 없는 컬럼

### 5️⃣ exportParticipants.ts 수정
- **Participant 인터페이스**: 기존 스키마에 맞게 수정
- **Excel 컬럼 매핑**: 
  - `participant_name` → `name`
  - `company_name` → `organization`
  - `participant_contact` → `phone`
  - `manager_info.team` → `team_name`
  - `manager_info.name` → `manager_name`
  - `manager_info.contact` → `manager_phone`
- **불필요한 컬럼 제거**: SFE 코드, 숙박예정, 담당자 사번

## QA 검증 결과 ✅
| 항목 | 결과 |
|------|------|
| `/admin/dashboard` 접속 시 콘솔 에러 | ✅ 해결 |
| `/admin/events/:eventId` 업로드 모달 열기 | ✅ 정상 |
| 엑셀 업로드 시 RPC 400 에러 | ✅ 해결 |
| 참가자 데이터 DB 저장 | ✅ `name`, `organization`, `phone` 컬럼에 정상 저장 |
| 참가자 리스트 표시 | ✅ 업로드된 데이터 정상 표시 |
| 담당자 정보 저장/표시 | ✅ `team_name`, `manager_name`, `manager_phone` 정상 작동 |
| Excel 내보내기 | ✅ 기존 스키마 컬럼으로 정상 내보내기 |

## 기술 스택
- Frontend: React, TypeScript, SWR
- Backend: Supabase (PostgreSQL + RPC)
- Excel: XLSX library

## 마이그레이션 파일
- `supabase/migrations/[timestamp]_fix_bulk_upload_schema.sql`

## 완료 로그
```
[71-I.QA3-FIX.R3]
✅ Modal guard: open state check added
✅ Excel parsing: mapped to name, organization, phone
✅ RPC: using existing schema columns
✅ ParticipantsPanel: interface & rendering updated
✅ ParticipantRightPanel: removed non-existent columns
✅ exportParticipants: schema sync complete
✅ All console errors resolved
```
