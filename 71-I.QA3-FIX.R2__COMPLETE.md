# Phase 71-I.QA3-FIX.R2: AgencyScope Sync + Upload Guard Hotfix

## 완료 사항

### 1️⃣ Database: fn_bulk_upload_participants 핫픽스
- ✅ `v_is_master` boolean 플래그 추가로 마스터 권한 확인
- ✅ `v_agency_id is null` 체크 추가 (EVENT_NOT_FOUND)
- ✅ 마스터 사용자는 agency scope 불일치 시에도 업로드 허용
- ✅ 빈 `participant_name` 필터링 추가
- ✅ 반환값에 `event_id` 추가

### 2️⃣ Upload Modal: 자동 RPC 트리거 방지
- ✅ useEffect에서 불필요한 RPC 자동 호출 제거됨
- ✅ `handleUpload`만 명시적으로 업로드 실행
- ✅ "Current Event" 텍스트 제거 (이벤트 이름만 표시)

### 3️⃣ Upload Guard 강화
- ✅ `agencyScope` 및 `eventId` 필수 검증 추가
- ✅ 누락 시 콘솔 경고 + Toast 안내
- ✅ 업로드 전 guard로 조기 차단

### 4️⃣ 콘솔 로그 개선
- ✅ 모든 로그에 `[71-I.QA3-FIX.R2]` 태그 추가
- ✅ 업로드 성공/실패 시 명확한 로그 출력
- ✅ SWR 캐시 무효화 로그 확인 가능

## QA 체크리스트

| 항목 | 상태 |
|------|------|
| 에이전시 대시보드 진입 시 | ✅ 업로드 RPC 자동 실행 안 됨 |
| 참가자 업로드 실행 시 | ✅ 콘솔 에러 없음 |
| 마스터 / 오너 / 스태프 업로드 | ✅ 동일 행사 내 정상 반영 |
| agencyScope 불일치 시 | ✅ 마스터만 예외 허용 |
| "Current Event" 텍스트 | ✅ 제거됨 |
| 업로드 실패 시 | ✅ Toast "행사 페이지에서만 업로드 가능" 표시 |
| 업로드 성공 시 | ✅ Toast "N명 참가자 반영 완료" + 리스트 자동 갱신 |

## 변경 파일
- `supabase/migrations/[timestamp]_qa3_fix_r2.sql` (new)
- `src/components/dashboard/UploadParticipantsModal.tsx` (updated)

## 완료 로그
```
[71-I.QA3-FIX.R2]
AgencyScope mismatch resolved — auto RPC trigger removed, 
event text removed, upload guard enabled, Supabase RPC hardened.
```
