# Phase 73-L.3: Schema Safety Net + RPC Rebuild - SQL Script

**Status**: Migration files are read-only. Execute this SQL manually in Supabase SQL Editor.

```sql
-- Phase 73-L.3: Schema Safety Net + RPC Rebuild
-- Ensures manager_info, organization exist and removes legacy column dependencies

-- 1) Ensure manager_info JSONB column exists
ALTER TABLE public.participants
  ADD COLUMN IF NOT EXISTS manager_info JSONB NOT NULL DEFAULT '{}'::jsonb;

-- 2) Ensure organization field exists (for 거래처명)
ALTER TABLE public.participants
  ADD COLUMN IF NOT EXISTS organization TEXT;

-- 3) Create unique constraint for upsert: (event_id, name, phone)
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint 
    WHERE conname = 'uq_participants_event_name_phone'
  ) THEN
    -- Remove duplicates first
    DELETE FROM public.participants a
    USING public.participants b
    WHERE a.id > b.id
      AND a.event_id = b.event_id
      AND a.name = b.name
      AND a.phone = b.phone;
    
    -- Create unique constraint
    ALTER TABLE public.participants
      ADD CONSTRAINT uq_participants_event_name_phone 
      UNIQUE (event_id, name, phone);
  END IF;
END $$;

-- 4) Update existing RPC: ai_participant_import_from_excel
CREATE OR REPLACE FUNCTION public.ai_participant_import_from_excel(
  p_event_id UUID,
  p_data JSONB,
  p_replace BOOLEAN DEFAULT false
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_ins INT := 0;
  v_upd INT := 0;
  v_skip INT := 0;
  v_skipped JSONB := '[]'::jsonb;
  v_row RECORD;
  v_name TEXT;
  v_phone TEXT;
  v_organization TEXT;
  v_memo TEXT;
  v_manager_info JSONB;
  v_created_at TIMESTAMP WITH TIME ZONE;
  v_exists BOOLEAN;
  v_agency_id UUID;
  v_deleted INT := 0;
BEGIN
  -- Get agency_id from event
  SELECT agency_id INTO v_agency_id
  FROM public.events
  WHERE id = p_event_id;

  -- Replace mode: soft delete existing participants
  IF p_replace THEN
    UPDATE public.participants
    SET is_active = false, updated_at = NOW()
    WHERE event_id = p_event_id AND is_active = true;
    
    GET DIAGNOSTICS v_deleted = ROW_COUNT;
  END IF;

  -- Process each row
  FOR v_row IN SELECT * FROM jsonb_array_elements(p_data)
  LOOP
    -- Extract and trim required fields
    v_name := NULLIF(TRIM(v_row.value->>'고객 성명'), '');
    v_phone := NULLIF(TRIM(v_row.value->>'고객 연락처'), '');
    
    -- Skip if required fields are missing
    IF v_name IS NULL OR v_phone IS NULL THEN
      v_skip := v_skip + 1;
      v_skipped := v_skipped || jsonb_build_object(
        'row', v_row.value,
        'reason', 'name/phone required'
      );
      CONTINUE;
    END IF;

    -- Extract optional fields
    v_organization := NULLIF(TRIM(v_row.value->>'거래처명'), '');
    v_memo := NULLIF(TRIM(v_row.value->>'메모'), '');
    
    -- Build manager_info JSON with SFE codes
    v_manager_info := jsonb_strip_nulls(jsonb_build_object(
      'team', NULLIF(TRIM(v_row.value->>'팀명'), ''),
      'name', NULLIF(TRIM(v_row.value->>'담당자 성명'), ''),
      'phone', NULLIF(TRIM(v_row.value->>'담당자 연락처'), ''),
      'emp_id', NULLIF(TRIM(v_row.value->>'담당자 사번'), ''),
      'sfe_hospital_code', NULLIF(NULLIF(TRIM(v_row.value->>'SFE 거래처코드'), ''), '-'),
      'sfe_customer_code', NULLIF(NULLIF(TRIM(v_row.value->>'SFE 고객코드'), ''), '-')
    ));
    
    -- Parse created_at if provided
    BEGIN
      v_created_at := to_timestamp(
        NULLIF(TRIM(v_row.value->>'등록 일시'), ''),
        'YYYY-MM-DD HH24:MI:SS'
      );
    EXCEPTION WHEN OTHERS THEN
      v_created_at := NOW();
    END;

    -- Check if record exists
    SELECT EXISTS(
      SELECT 1 FROM public.participants
      WHERE event_id = p_event_id
        AND name = v_name
        AND phone = v_phone
    ) INTO v_exists;

    BEGIN
      -- Upsert
      INSERT INTO public.participants (
        event_id,
        agency_id,
        name,
        phone,
        organization,
        memo,
        manager_info,
        role_badge,
        composition,
        is_active,
        created_at,
        updated_at
      )
      VALUES (
        p_event_id,
        v_agency_id,
        v_name,
        v_phone,
        v_organization,
        v_memo,
        v_manager_info,
        '참석자',
        '{"adult": 1, "child": 0, "infant": 0}'::jsonb,
        true,
        v_created_at,
        NOW()
      )
      ON CONFLICT (event_id, name, phone)
      DO UPDATE SET
        organization = EXCLUDED.organization,
        memo = EXCLUDED.memo,
        manager_info = participants.manager_info || EXCLUDED.manager_info,
        is_active = true,
        updated_at = NOW();

      -- Track insert vs update
      IF v_exists THEN
        v_upd := v_upd + 1;
      ELSE
        v_ins := v_ins + 1;
      END IF;

    EXCEPTION WHEN OTHERS THEN
      v_skip := v_skip + 1;
      v_skipped := v_skipped || jsonb_build_object(
        'row', v_row.value,
        'reason', SQLERRM
      );
    END;
  END LOOP;

  -- Log to participants_log
  INSERT INTO public.participants_log (
    event_id,
    agency_id,
    action,
    metadata
  )
  VALUES (
    p_event_id,
    v_agency_id,
    'bulk_upload',
    jsonb_build_object(
      'mode', CASE WHEN p_replace THEN 'replace' ELSE 'update' END,
      'inserted', v_ins,
      'updated', v_upd,
      'skipped', v_skip,
      'deleted', v_deleted
    )
  );

  -- Broadcast real-time update
  PERFORM pg_notify(
    'participants_upload',
    json_build_object(
      'event_id', p_event_id,
      'inserted', v_ins,
      'updated', v_upd,
      'skipped', v_skip
    )::text
  );

  RETURN jsonb_build_object(
    'success', true,
    'total', v_ins + v_upd,
    'inserted', v_ins,
    'updated', v_upd,
    'skipped', v_skip,
    'deleted', v_deleted,
    'mode', CASE WHEN p_replace THEN 'replace' ELSE 'update' END,
    'event_id', p_event_id,
    'agency_id', v_agency_id,
    'session_id', 'excel_' || extract(epoch from now())::bigint::text
  );
END;
$$;

-- Grant execute permission
GRANT EXECUTE ON FUNCTION public.ai_participant_import_from_excel(uuid, jsonb, boolean) TO authenticated;
GRANT EXECUTE ON FUNCTION public.ai_participant_import_from_excel(uuid, jsonb, boolean) TO service_role;
```

## QA Verification Query

```sql
-- Check manager_info JSON structure
SELECT 
  name, 
  phone,
  organization,
  manager_info->>'team' as team,
  manager_info->>'name' as manager_name,
  manager_info->>'sfe_hospital_code' as sfe_hospital,
  manager_info->>'sfe_customer_code' as sfe_customer
FROM participants
WHERE event_id = 'YOUR_EVENT_ID'
ORDER BY name
LIMIT 20;

-- Verify unique constraint
SELECT conname, contype
FROM pg_constraint
WHERE conrelid = 'participants'::regclass
  AND conname = 'uq_participants_event_name_phone';
```

## Rollback (if needed)

```sql
-- Drop the constraint
ALTER TABLE public.participants
  DROP CONSTRAINT IF EXISTS uq_participants_event_name_phone;

-- Revert to old RPC (if you have backup)
-- DROP FUNCTION public.ai_participant_import_from_excel(uuid, jsonb, boolean);
```
